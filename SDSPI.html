<pre>
<font color="#5e6d03">#include</font> <font color="#434f54">&lt;</font><font color="#000000">stdbool</font><font color="#434f54">.</font><font color="#000000">h</font><font color="#434f54">&gt;</font>
<font color="#5e6d03">#include</font> <font color="#434f54">&lt;</font><font color="#000000">stdint</font><font color="#434f54">.</font><font color="#000000">h</font><font color="#434f54">&gt;</font>
<font color="#5e6d03">#include</font> <font color="#434f54">&lt;</font><font color="#000000">string</font><font color="#434f54">.</font><font color="#000000">h</font><font color="#434f54">&gt;</font>
<font color="#5e6d03">#include</font> <font color="#005c5f">&#34;..&#47;pin_manager.h&#34;</font>
<font color="#5e6d03">#include</font> <font color="#005c5f">&#34;..&#47;drivers&#47;spi_master.h&#34;</font>

<font color="#95a5a6">&#47;******************************************************************************&#47;</font>
<font color="#95a5a6">&#47;* SD Configuration &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&#47;</font>
<font color="#95a5a6">&#47;******************************************************************************&#47;</font>
<font color="#434f54">&#47;&#47; Description: Media Response Delay Timeout Values</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_SPI_STARTUP_DELAY_MS</font> <font color="#000000">30u</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_SPI_COMMAND_WAIT_MS</font> <font color="#000000">1u</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_NCR_TIMEOUT</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">uint16_t</font><font color="#000000">)</font><font color="#000000">20</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;byte times before command response is expected (must be at least 8)</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_NAC_TIMEOUT</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">uint32_t</font><font color="#000000">)</font><font color="#000000">0x40000</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;SPI byte times we should wait when performing read operations (should be at least 100ms for SD cards)</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_WRITE_TIMEOUT</font> &nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">uint32_t</font><font color="#000000">)</font><font color="#000000">0xA0000</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;SPI byte times to wait before timing out when the media is performing a write operation (should be at least 250ms for SD cards).</font>

<font color="#5e6d03">#define</font> <font color="#000000">SD_SPI_ChipSelect</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#000000">SDCard_CS_SetLow</font><font color="#000000">(</font><font color="#000000">)</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_SPI_ChipDeselect</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#000000">SDCard_CS_SetHigh</font><font color="#000000">(</font><font color="#000000">)</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#d35400">data</font><font color="#000000">)</font> <font color="#000000">spiMaster</font><font color="#000000">[</font><font color="#000000">SDFAST</font><font color="#000000">]</font><font color="#434f54">.</font><font color="#000000">exchangeByte</font><font color="#000000">(</font><font color="#d35400">data</font><font color="#000000">)</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_SPI_exchangeBlock</font><font color="#000000">(</font><font color="#d35400">data</font><font color="#434f54">,</font> <font color="#d35400">length</font><font color="#000000">)</font> <font color="#000000">spiMaster</font><font color="#000000">[</font><font color="#000000">SDFAST</font><font color="#000000">]</font><font color="#434f54">.</font><font color="#000000">exchangeBlock</font><font color="#000000">(</font><font color="#d35400">data</font><font color="#434f54">,</font> <font color="#d35400">length</font><font color="#000000">)</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_SPI_master_open</font><font color="#000000">(</font><font color="#d35400">config</font><font color="#000000">)</font> <font color="#000000">spiMaster</font><font color="#000000">[</font><font color="#d35400">config</font><font color="#000000">]</font><font color="#434f54">.</font><font color="#000000">spiOpen</font><font color="#000000">(</font><font color="#000000">)</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_SPI_close</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#000000">spiMaster</font><font color="#000000">[</font><font color="#000000">SDFAST</font><font color="#000000">]</font><font color="#434f54">.</font><font color="#000000">spiClose</font><font color="#000000">(</font><font color="#000000">)</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_SPI_GetCardDetect</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#000000">1</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_SPI_GetWriteProtect</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#000000">0</font>


<font color="#95a5a6">&#47;*****************************************************************************&#47;</font>
<font color="#95a5a6">&#47;* &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Custom structures and definitions &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&#47;</font>
<font color="#95a5a6">&#47;*****************************************************************************&#47;</font>

<font color="#95a5a6">&#47;* in SPI SLOW mode (&lt;400kHz) 400kHz = 400 clocks for 1ms.</font>
<font color="#95a5a6"> * 8 clocks per byte = 50 bytes of dummy data results in at least 1ms</font>
<font color="#95a5a6"> * of delay. *&#47;</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_SLOW_CLOCK_DELAY_1MS_MIN</font> <font color="#000000">50u</font> 

<font color="#434f54">&#47;&#47;Definition for a structure used when calling either SD_AsyncReadTasks()</font>
<font color="#434f54">&#47;&#47;function, or the SD_AsyncWriteTasks() function.</font>
<font color="#00979c">struct</font> <font color="#000000">SD_ASYNC_IO</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint16_t</font> <font color="#000000">wNumBytes</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Number of bytes to attempt to read or write in the next call to MDD_SDSPI_AsyncReadTasks() or MDD_SDSPI_AsyncWriteTasks. &nbsp;May be updated between calls to the handler.</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint32_t</font> <font color="#000000">dwBytesRemaining</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;Should be initialized to the total number of uint8_ts that you wish to read or write. &nbsp;This value is allowed to be greater than a single block size of the media.</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font><font color="#434f54">*</font> <font color="#000000">pBuffer</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Pointer to where the read&#47;written uint8_ts should be copied to&#47;from. &nbsp;May be updated between calls to the handler function.</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint32_t</font> <font color="#000000">dwAddress</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Starting block address to read or to write to on the media. &nbsp;Should only get initialized, do not modify after that.</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> <font color="#000000">bStateVariable</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;State machine variable. &nbsp;Should get initialized to ASYNC_READ_QUEUED or ASYNC_WRITE_QUEUED to start an operation. &nbsp;After that, do not modify until the read or write is complete.</font>
<font color="#000000">}</font><font color="#000000">;</font>

<font color="#434f54">&#47;&#47;Response codes for the SD_AsyncReadTasks() function.</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_READ_COMPLETE</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x00</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_READ_BUSY</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x01</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_READ_NEW_PACKET_READY</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x02</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_READ_ERROR</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xFF</font>

<font color="#434f54">&#47;&#47;SD_AsyncReadTasks() state machine variable values. These are used internally to sd_spi.c.</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_READ_COMPLETE</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x00</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_READ_QUEUED</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x01</font> &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Initialize to this to start a read sequence</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_READ_WAIT_START_TOKEN</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x03</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_READ_NEW_PACKET_READY</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x02</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_READ_ABORT</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xFE</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_READ_ERROR</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xFF</font>

<font color="#434f54">&#47;&#47;Possible return values when calling SD_AsyncWriteTasks()</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_WRITE_COMPLETE</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x00</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_WRITE_SEND_PACKET</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x02</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_WRITE_BUSY</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x03</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_WRITE_ERROR</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xFF</font>

<font color="#434f54">&#47;&#47;SD_AsyncWriteTasks() state machine variable values. These are used internally to sd_spi.c.</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_WRITE_COMPLETE</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x00</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_WRITE_QUEUED</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x01</font> &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Initialize to this to start a write sequence</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_WRITE_TRANSMIT_PACKET</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x02</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_WRITE_MEDIA_BUSY</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x03</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_STOP_TOKEN_SENT_WAIT_BUSY</font> <font color="#000000">0x04</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_WRITE_ABORT</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xFE</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_ASYNC_WRITE_ERROR</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xFF</font>

<font color="#5e6d03">#define</font> <font color="#000000">SD_MEDIA_BLOCK_SIZE</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">512u</font> &nbsp;<font color="#434f54">&#47;&#47;Should always be 512 for v1 and v2 devices.</font>

<font color="#00979c">enum</font> <font color="#000000">SD_STATE</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_STATE_NOT_INITIALIZED</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_STATE_READY_FOR_COMMAND</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_STATE_BUSY</font>
<font color="#000000">}</font><font color="#000000">;</font>

<font color="#00979c">enum</font> <font color="#000000">MEDIA_ERRORS</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">MEDIA_NO_ERROR</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; No errors</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">MEDIA_DEVICE_NOT_PRESENT</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; The requested device is not present</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">MEDIA_CANNOT_INITIALIZE</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Cannot initialize media</font>
<font color="#000000">}</font> <font color="#000000">;</font>

<font color="#434f54">&#47;&#47; Media information flags. &nbsp;The driver&#39;s MediaInitialize function will return a pointer to one of these structures.</font>
<font color="#00979c">struct</font> <font color="#000000">MEDIA_INFORMATION</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">enum</font> <font color="#000000">MEDIA_ERRORS</font> <font color="#000000">errorCode</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; The status of the initialization MEDIA_ERRORS</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint16_t</font> &nbsp;&nbsp;&nbsp;<font color="#000000">sectorSize</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; The sector size of the target device.</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">enum</font> <font color="#000000">SD_STATE</font> <font color="#d35400">state</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint32_t</font> <font color="#000000">finalLBA</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> <font color="#000000">gSDMode</font><font color="#000000">;</font>
<font color="#000000">}</font><font color="#000000">;</font>

<font color="#95a5a6">&#47;******************************************************************************</font>
<font color="#95a5a6"> * Global Variables</font>
<font color="#95a5a6"> *****************************************************************************&#47;</font>
<font color="#00979c">enum</font> <font color="#000000">SD_TOKEN</font>
<font color="#000000">{</font> 
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_TOKEN_START</font> <font color="#434f54">=</font> <font color="#000000">0xFE</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_TOKEN_START_MULTI_BLOCK</font> <font color="#434f54">=</font> <font color="#000000">0xFC</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_TOKEN_STOP_TRANSMISSION</font> <font color="#434f54">=</font> <font color="#000000">0xFD</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_TOKEN_DATA_ACCEPTED</font> <font color="#434f54">=</font> <font color="#000000">0x05</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_TOKEN_FLOATING_BUS</font> <font color="#434f54">=</font> <font color="#000000">0xFF</font>
<font color="#000000">}</font><font color="#000000">;</font>

<font color="#00979c">enum</font> <font color="#000000">SD_COMMAND</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defines the command code to reset the SD card</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_GO_IDLE_STATE</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">0</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defines the command code to initialize the SD card</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_SEND_OP_COND</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">1</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defined the command code to check for sector addressing</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_SEND_IF_COND</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">8</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defines the command code to get the Card Specific Data</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_SEND_CSD</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">9</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defines the command code to get the Card Information</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_SEND_CID</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">10</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defines the command code to stop transmission during a multi-block read</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_STOP_TRANSMISSION</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">12</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defines the command code to get the card status information</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_SEND_STATUS</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">13</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defines the command code to set the block length of the card</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_SET_BLOCK_LENGTH</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">16</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defines the command code to read one block from the card</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_READ_SINGLE_BLOCK</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">17</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defines the command code to read multiple blocks from the card</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_READ_MULTI_BLOCK</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">18</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defines the command code to tell the media how many blocks to pre-erase (for faster multi-block writes to follow)</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Note: This is an &#34;application specific&#34; command. &nbsp;This tells the media how many blocks to pre-erase for the subsequent WRITE_MULTI_BLOCK</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_SET_WRITE_BLOCK_ERASE_COUNT</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">23</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defines the command code to write one block to the card</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_WRITE_SINGLE_BLOCK</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">24</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defines the command code to write multiple blocks to the card</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_WRITE_MULTI_BLOCK</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">25</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defines the command code to set the address of the start of an erase operation</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_TAG_SECTOR_START</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">32</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defines the command code to set the address of the end of an erase operation</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_TAG_SECTOR_END</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">33</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defines the command code to erase all previously selected blocks</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_ERASE</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">38</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Description: This macro defines the command code to initialize an SD card and provide the CSD register value.</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Note: this is an &#34;application specific&#34; command (specific to SD cards) and must be preceded by cmdAPP_CMD.</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_SD_SEND_OP_COND</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">41</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defines the command code to begin application specific command inputs</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_APP_CMD</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">55</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defines the command code to get the OCR register information from the card</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_READ_OCR</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">58</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Description: This macro defines the command code to disable CRC checking</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_COMMAND_CRC_ON_OFF</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">=</font> <font color="#000000">59</font>
<font color="#000000">}</font><font color="#000000">;</font>

<font color="#5e6d03">#define</font> <font color="#000000">SD_MODE_NORMAL</font> &nbsp;<font color="#000000">0</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_MODE_HC</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">1</font>

<font color="#434f54">&#47;&#47;Constants</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_WRITE_RESPONSE_TOKEN_MASK</font> &nbsp;&nbsp;<font color="#000000">0x1F</font> &nbsp;<font color="#434f54">&#47;&#47;Bit mask to AND with the write token response uint8_t from the media, to clear the don&#39;t care bits.</font>

<font color="#434f54">&#47;&#47; Description: Enumeration of different SD response types</font>
<font color="#00979c">typedef</font> <font color="#00979c">enum</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R1</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; R1 type response</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R1b</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; R1b type response</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R2</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; R2 type response</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R3</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; R3 type response</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R7</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; R7 type response</font>
<font color="#000000">}</font><font color="#000000">SD_RESPONSE_TYPE</font><font color="#000000">;</font>

<font color="#5e6d03">#define</font> <font color="#000000">SD_COMMAND_CODE_BIT_MASK</font> <font color="#000000">(</font><font color="#000000">0b00111111</font><font color="#000000">)</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_COMMAND_TRANSMIT_BIT_MASK</font> <font color="#000000">(</font><font color="#000000">1</font><font color="#434f54">&lt;&lt;</font><font color="#000000">6</font><font color="#000000">)</font>
<font color="#5e6d03">#define</font> <font color="#000000">SD_COMMAND_START_BIT_MASK</font> <font color="#000000">(</font><font color="#000000">1</font><font color="#434f54">&lt;&lt;</font><font color="#000000">6</font><font color="#000000">)</font>


<font color="#434f54">&#47;&#47; Summary: The format of an R1 type response</font>
<font color="#434f54">&#47;&#47; Description: This union represents different ways to access an SD card R1 type response packet.</font>
<font color="#00979c">typedef</font> <font color="#00979c">union</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> <font color="#000000">_byte</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; byte-wise access</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; This structure allows bitwise access of the response</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">struct</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">IN_IDLE_STATE</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Card is in idle state</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">ERASE_RESET</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Erase reset flag</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">ILLEGAL_CMD</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Illegal command flag</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">CRC_ERR</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; CRC error flag</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">ERASE_SEQ_ERR</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Erase sequence error flag</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">ADDRESS_ERR</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Address error flag</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">PARAM_ERR</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Parameter flag &nbsp;&nbsp;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">B7</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Unused bit 7</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#000000">;</font>
<font color="#000000">}</font> <font color="#000000">SD_RESPONSE_1</font><font color="#000000">;</font>

<font color="#434f54">&#47;&#47; Summary: The format of an R2 type response</font>
<font color="#434f54">&#47;&#47; Description: This union represents different ways to access an SD card R2 type response packet</font>
<font color="#00979c">typedef</font> <font color="#00979c">union</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint16_t</font> <font color="#000000">_uint16_t</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">struct</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">_byte0</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">_byte1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">struct</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">IN_IDLE_STATE</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">ERASE_RESET</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">ILLEGAL_CMD</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">CRC_ERR</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">ERASE_SEQ_ERR</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">ADDRESS_ERR</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">PARAM_ERR</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">B7</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">CARD_IS_LOCKED</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">WP_ERASE_SKIP_LK_FAIL</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#00979c">ERROR</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">CC_ERROR</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">CARD_ECC_FAIL</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">WP_VIOLATION</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">ERASE_PARAM</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">OUTRANGE_CSD_OVERWRITE</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#000000">;</font>
<font color="#000000">}</font> <font color="#000000">SD_RESPONSE_2</font><font color="#000000">;</font>

<font color="#434f54">&#47;&#47; Summary: The format of an R7 or R3 type response</font>
<font color="#434f54">&#47;&#47; Description: This union represents different ways to access an SD card R7 type response packet.</font>
<font color="#00979c">typedef</font> <font color="#00979c">union</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">struct</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> <font color="#000000">_byte</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; byte-wise access</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">union</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Note: The SD card argument response field is 32-bit, big endian format.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;However, the C compiler stores 32-bit values in little endian in RAM.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;When writing to the _returnVal&#47;argument bytes, make sure to byte</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;swap the order from which it arrived over the SPI from the SD card.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">uint32_t</font> <font color="#000000">_returnVal</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">struct</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> <font color="#000000">_byte0</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> <font color="#000000">_byte1</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> <font color="#000000">_byte2</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> <font color="#000000">_byte3</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#000000">argument</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font> <font color="#000000">bytewise</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; This structure allows bitwise access of the response</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">struct</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">struct</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">IN_IDLE_STATE</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Card is in idle state</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">ERASE_RESET</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Erase reset flag</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">ILLEGAL_CMD</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Illegal command flag</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">CRC_ERR</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; CRC error flag</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">ERASE_SEQ_ERR</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Erase sequence error flag</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">ADDRESS_ERR</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Address error flag</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">PARAM_ERR</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Parameter flag &nbsp;&nbsp;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">unsigned</font> <font color="#000000">B7</font><font color="#434f54">:</font><font color="#000000">1</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Unused bit 7</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#d35400">bits</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">uint32_t</font> <font color="#000000">_returnVal</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font> <font color="#000000">bitwise</font><font color="#000000">;</font>
<font color="#000000">}</font> <font color="#000000">SD_RESPONSE_7</font><font color="#000000">;</font>

<font color="#434f54">&#47;&#47; Summary: A union of responses from an SD card</font>
<font color="#434f54">&#47;&#47; Description: The SD_RESPONSE union represents any of the possible responses that an SD card can return after</font>
<font color="#434f54">&#47;&#47; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;being issued a command.</font>
<font color="#00979c">typedef</font> <font color="#00979c">union</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_RESPONSE_1</font> &nbsp;<font color="#000000">r1</font><font color="#000000">;</font> &nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_RESPONSE_2</font> &nbsp;<font color="#000000">r2</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_RESPONSE_7</font> &nbsp;<font color="#000000">r7</font><font color="#000000">;</font>
<font color="#000000">}</font><font color="#000000">SD_RESPONSE</font><font color="#000000">;</font>

<font color="#434f54">&#47;&#47; Description: &nbsp;Used for the mass-storage library to determine capacity</font>
<font color="#00979c">static</font> <font color="#00979c">struct</font> <font color="#000000">MEDIA_INFORMATION</font> <font color="#000000">mediaInformation</font> <font color="#434f54">=</font> <font color="#000000">{</font><font color="#000000">MEDIA_NO_ERROR</font><font color="#434f54">,</font> <font color="#000000">SD_MEDIA_BLOCK_SIZE</font><font color="#434f54">,</font> <font color="#000000">SD_STATE_NOT_INITIALIZED</font><font color="#434f54">,</font> <font color="#000000">0ul</font><font color="#434f54">,</font> <font color="#000000">SD_MODE_NORMAL</font><font color="#000000">}</font><font color="#000000">;</font>
<font color="#00979c">static</font> <font color="#00979c">struct</font> <font color="#000000">SD_ASYNC_IO</font> <font color="#000000">ioInfo</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;Declared global context, for fast&#47;code efficient access</font>

<font color="#434f54">&#47;&#47; Summary: An enumeration of SD commands</font>
<font color="#434f54">&#47;&#47; Description: This enumeration corresponds to the position of each command in the sdmmc_cmdtable array</font>
<font color="#434f54">&#47;&#47; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;These macros indicate to the SD_SendCmd function which element of the sdmmc_cmdtable array</font>
<font color="#434f54">&#47;&#47; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to retrieve command code information from.</font>
<font color="#00979c">enum</font> <font color="#000000">SD_COMMAND_INDEX</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_GO_IDLE_STATE</font> <font color="#434f54">=</font> <font color="#000000">0</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_SEND_OP_COND</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_SEND_IF_COND</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_SEND_CSD</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_SEND_CID</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_STOP_TRANSMISSION</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_SEND_STATUS</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_SET_BLOCK_LENGTH</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_READ_SINGLE_BLOCK</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_READ_MULTI_BLOCK</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_WRITE_SINGLE_BLOCK</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_WRITE_MULTI_BLOCK</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_TAG_SECTOR_START</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_TAG_SECTOR_END</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_ERASE</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_APP_CMD</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_READ_OCR</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_CRC_ON_OFF</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_SD_SEND_OP_COND</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_SET_WRITE_BLOCK_ERASE_COUNT</font>
<font color="#000000">}</font> <font color="#000000">;</font>

<font color="#434f54">&#47;&#47; Summary: SD card command data structure</font>
<font color="#434f54">&#47;&#47; Description: The SD_COMMAND structure is used to create a command table of information needed for each relevant SD command</font>
<font color="#00979c">struct</font> <font color="#000000">SD_COMMAND_TABLE_ENTRY</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">enum</font> <font color="#000000">SD_COMMAND</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">CmdCode</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; The command code</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">CRC</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; The CRC value for that command</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_RESPONSE_TYPE</font> &nbsp;&nbsp;&nbsp;<font color="#000000">responsetype</font><font color="#000000">;</font> &nbsp;&nbsp;<font color="#434f54">&#47;&#47; The response type</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">bool</font> <font color="#000000">moreDataExpected</font><font color="#000000">;</font>
<font color="#000000">}</font><font color="#000000">;</font>


<font color="#434f54">&#47;&#47; Summary: Table of SD card commands and parameters</font>
<font color="#434f54">&#47;&#47; Description: The sdmmc_cmdtable contains an array of SD card commands, the corresponding CRC code, the</font>
<font color="#434f54">&#47;&#47; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response type that the card will return, and a parameter indicating whether to expect</font>
<font color="#434f54">&#47;&#47; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;additional data from the card.</font>
<font color="#00979c">static</font> <font color="#00979c">const</font> <font color="#00979c">struct</font> <font color="#000000">SD_COMMAND_TABLE_ENTRY</font> <font color="#000000">sdmmc_cmdtable</font><font color="#000000">[</font><font color="#000000">]</font> <font color="#434f54">=</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; cmd &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crc &nbsp;&nbsp;&nbsp;&nbsp;response &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;more data expected</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_GO_IDLE_STATE</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x95</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R1</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">false</font><font color="#000000">}</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_SEND_OP_COND</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xF9</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R1</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">false</font><font color="#000000">}</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_SEND_IF_COND</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x87</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R7</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">false</font><font color="#000000">}</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_SEND_CSD</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xAF</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R1</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">true</font><font color="#000000">}</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_SEND_CID</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x1B</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R1</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">true</font><font color="#000000">}</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_STOP_TRANSMISSION</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xC3</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R1b</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;<font color="#00979c">false</font><font color="#000000">}</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_SEND_STATUS</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xAF</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R2</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">false</font><font color="#000000">}</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_SET_BLOCK_LENGTH</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xFF</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R1</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">false</font><font color="#000000">}</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_READ_SINGLE_BLOCK</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xFF</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R1</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">true</font><font color="#000000">}</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_READ_MULTI_BLOCK</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xFF</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R1</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">true</font><font color="#000000">}</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_WRITE_SINGLE_BLOCK</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xFF</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R1</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">true</font><font color="#000000">}</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_WRITE_MULTI_BLOCK</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xFF</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R1</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">true</font><font color="#000000">}</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_TAG_SECTOR_START</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xFF</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R1</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">false</font><font color="#000000">}</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_TAG_SECTOR_END</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xFF</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R1</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">false</font><font color="#000000">}</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_ERASE</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xDF</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R1b</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;<font color="#00979c">false</font><font color="#000000">}</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_APP_CMD</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x73</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R1</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">false</font><font color="#000000">}</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_READ_OCR</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x25</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R7</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">false</font><font color="#000000">}</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_CRC_ON_OFF</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0x25</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R1</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">false</font><font color="#000000">}</font><font color="#434f54">,</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_SD_SEND_OP_COND</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">0xFF</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R7</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">false</font><font color="#000000">}</font><font color="#434f54">,</font> <font color="#434f54">&#47;&#47;Actual response is R3, but has same number of bytes as R7.</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font><font color="#000000">SD_COMMAND_SET_WRITE_BLOCK_ERASE_COUNT</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;<font color="#000000">0xFF</font><font color="#434f54">,</font> &nbsp;&nbsp;<font color="#000000">SD_RESPONSE_R1</font><font color="#434f54">,</font> &nbsp;&nbsp;&nbsp;&nbsp;<font color="#00979c">false</font><font color="#000000">}</font>
<font color="#000000">}</font><font color="#000000">;</font>

<font color="#95a5a6">&#47;******************************************************************************</font>
<font color="#95a5a6"> * Private Prototypes</font>
<font color="#95a5a6"> *****************************************************************************&#47;</font>
<font color="#00979c">static</font> <font color="#000000">SD_RESPONSE</font> <font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#00979c">uint8_t</font> <font color="#000000">cmd</font><font color="#434f54">,</font> <font color="#00979c">uint32_t</font> <font color="#000000">address</font><font color="#000000">)</font><font color="#000000">;</font>
<font color="#00979c">static</font> <font color="#00979c">uint8_t</font> <font color="#000000">SD_SPI_AsyncWriteTasks</font><font color="#000000">(</font><font color="#00979c">struct</font> <font color="#000000">SD_ASYNC_IO</font><font color="#434f54">*</font> <font color="#000000">info</font><font color="#000000">)</font><font color="#000000">;</font>
<font color="#00979c">static</font> <font color="#00979c">uint8_t</font> <font color="#000000">SD_SPI_AsyncReadTasks</font><font color="#000000">(</font><font color="#00979c">struct</font> <font color="#000000">SD_ASYNC_IO</font><font color="#434f54">*</font> <font color="#000000">info</font><font color="#000000">)</font><font color="#000000">;</font>


<font color="#00979c">static</font> <font color="#00979c">void</font> <font color="#000000">SDSPI_DelayMilliseconds</font><font color="#000000">(</font><font color="#00979c">uint8_t</font> <font color="#d35400">milliseconds</font><font color="#000000">)</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint16_t</font> <font color="#000000">timeout</font> <font color="#434f54">=</font> <font color="#000000">SD_SLOW_CLOCK_DELAY_1MS_MIN</font> <font color="#434f54">*</font> <font color="#d35400">milliseconds</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipDeselect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font><font color="#000000">(</font><font color="#000000">timeout</font><font color="#434f54">--</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
<font color="#000000">}</font>

<font color="#00979c">bool</font> <font color="#000000">SDSPI_IsMediaPresent</font><font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_SPI_GetCardDetect</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#434f54">?</font> <font color="#00979c">true</font><font color="#434f54">:</font> <font color="#00979c">false</font><font color="#000000">;</font>
<font color="#000000">}</font>

<font color="#00979c">bool</font> <font color="#000000">SDSPI_MediaInitialize</font><font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint16_t</font> <font color="#000000">timeout</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_RESPONSE</font> <font color="#d35400">response</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> <font color="#000000">CSDResponse</font><font color="#000000">[</font><font color="#000000">20</font><font color="#000000">]</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> <font color="#000000">count</font><font color="#434f54">,</font> <font color="#000000">index</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint32_t</font> <font color="#000000">c_size</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> <font color="#000000">c_size_mult</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> <font color="#000000">block_len</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#d35400">state</font> <font color="#434f54">=</font> <font color="#000000">SD_STATE_NOT_INITIALIZED</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">errorCode</font> <font color="#434f54">=</font> <font color="#000000">MEDIA_NO_ERROR</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">finalLBA</font> <font color="#434f54">=</font> <font color="#000000">0x00000000</font><font color="#000000">;</font> &nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">gSDMode</font> <font color="#434f54">=</font> <font color="#000000">SD_MODE_NORMAL</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipDeselect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;MMC media powers up in the open-drain mode and cannot handle a clock faster</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;than 400kHz. Initialize SPI port to &lt;= 400kHz</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font> <font color="#000000">SD_SPI_master_open</font><font color="#000000">(</font><font color="#000000">SDSLOW</font><font color="#000000">)</font> <font color="#434f54">==</font> <font color="#00979c">false</font> <font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#00979c">false</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>

 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Media wants the longer of: Vdd ramp time, 1 ms fixed delay, or 74+ clock pulses.</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;According to spec, CS should be high during the 74+ clock pulses.</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;In practice it is preferable to wait much longer than 1ms, in case of</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;contact bounce, or incomplete mechanical insertion (by the time we start</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;accessing the media). </font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SDSPI_DelayMilliseconds</font><font color="#000000">(</font><font color="#000000">SD_SPI_STARTUP_DELAY_MS</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Send CMD0 (with CS = 0) to reset the media and put SD cards into SPI mode.</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">timeout</font> <font color="#434f54">=</font> <font color="#000000">100</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">do</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Toggle chip select, to make media abandon whatever it may have been doing</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;before. &nbsp;This ensures the CMD0 is sent freshly after CS is asserted low,</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;minimizing risk of SPI clock pulse master&#47;slave synchronization problems, </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;due to possible application noise on the SCK line.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipDeselect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;<font color="#434f54">&#47;&#47;Send some &#34;extraneous&#34; clock pulses. &nbsp;If a previous</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;command was terminated before it completed normally,</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;the card might not have received the required clocking</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;following the transfer.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipSelect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">timeout</font><font color="#434f54">--</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Send CMD0 to software reset the device</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font> <font color="#434f54">=</font> <font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_GO_IDLE_STATE</font><font color="#434f54">,</font> <font color="#000000">0x0</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#5e6d03">while</font><font color="#000000">(</font><font color="#000000">(</font><font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r1</font><font color="#434f54">.</font><font color="#000000">_byte</font> <font color="#434f54">!=</font> <font color="#000000">0x01</font><font color="#000000">)</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">(</font><font color="#000000">timeout</font> <font color="#434f54">!=</font> <font color="#000000">0</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Check if all attempts failed and we timed out. &nbsp;Normally, this won&#39;t happen,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;unless maybe the SD card was busy, because it was previously performing a</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;read or write operation, when it was interrupted by the microcontroller getting</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;reset or power cycled, without also resetting or power cycling the SD card.</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;In this case, the SD card may still be busy (ex: trying to respond with the </font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;read request data), and may not be ready to process CMD0. &nbsp;In this case,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;we can try to recover by issuing CMD12 (STOP_TRANSMISSION).</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">timeout</font> <font color="#434f54">==</font> <font color="#000000">0</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipDeselect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Send some &#34;extraneous&#34; clock pulses. &nbsp;If a previous</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;command was terminated before it completed normally,</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;the card might not have received the required clocking</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;following the transfer.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipSelect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Send CMD12, to stop any read&#47;write transaction that may have been in progress</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_STOP_TRANSMISSION</font><font color="#434f54">,</font> <font color="#000000">0x0</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Blocks until SD card signals non-busy</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Now retry to send send CMD0 to perform software reset on the media</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font> <font color="#434f54">=</font> <font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_GO_IDLE_STATE</font><font color="#434f54">,</font> <font color="#000000">0x0</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r1</font><font color="#434f54">.</font><font color="#000000">_byte</font> <font color="#434f54">!=</font> <font color="#000000">0x01</font><font color="#000000">)</font> <font color="#434f54">&#47;&#47;Check if card in idle state now.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Card failed to process CMD0 yet again. &nbsp;At this point, the proper thing</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;to do would be to power cycle the card and retry, if the host </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;circuitry supports disconnecting the SD card power. &nbsp;Since the</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;SD&#47;MMC PICtail+ doesn&#39;t support software controlled power removal</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;of the SD card, there is nothing that can be done with this hardware.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Therefore, we just give up now. &nbsp;The user needs to physically </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;power cycle the media and&#47;or the whole board.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">errorCode</font> <font color="#434f54">=</font> <font color="#000000">MEDIA_CANNOT_INITIALIZE</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipDeselect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_close</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#00979c">false</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Card successfully processed CMD0 and is now in the idle state.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#434f54">&#47;&#47;if(timeout == 0) [for the CMD0 transmit loop]</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;

 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Send CMD8 (SEND_IF_COND) to specify&#47;request the SD card interface condition (ex: indicate what voltage the host runs at).</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;0x000001AA --&gt; VHS = 0001b = 2.7V to 3.6V. &nbsp;The 0xAA LSB is the check pattern, and is arbitrary, but 0xAA is recommended (good blend of 0&#39;s and &#39;1&#39;s).</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;The SD card has to echo back the check pattern correctly however, in the R7 response.</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;If the SD card doesn&#39;t support the operating voltage range of the host, then it may not respond.</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;If it does support the range, it will respond with a type R7 response packet (6 bytes&#47;48 bits). &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Additionally, if the SD card is MMC or SD card v1.x spec device, then it may respond with</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;invalid command. &nbsp;If it is a v2.0 spec SD card, then it is mandatory that the card respond</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;to CMD8.</font>
 &nbsp;&nbsp;&nbsp;<font color="#d35400">response</font> <font color="#434f54">=</font> <font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_SEND_IF_COND</font><font color="#434f54">,</font> <font color="#000000">0x1AA</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;&nbsp;<font color="#434f54">&#47;&#47;Note: If changing &#34;0x1AA&#34;, CRC value in table must also change.</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">(</font><font color="#000000">(</font><font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r7</font><font color="#434f54">.</font><font color="#000000">bytewise</font><font color="#434f54">.</font><font color="#000000">argument</font><font color="#434f54">.</font><font color="#000000">_returnVal</font> <font color="#434f54">&amp;</font> <font color="#000000">0xFFF</font><font color="#000000">)</font> <font color="#434f54">==</font> <font color="#000000">0x1AA</font><font color="#000000">)</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">(</font><font color="#434f54">!</font><font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r7</font><font color="#434f54">.</font><font color="#000000">bitwise</font><font color="#434f54">.</font><font color="#d35400">bits</font><font color="#434f54">.</font><font color="#000000">ILLEGAL_CMD</font><font color="#000000">)</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;If we get to here, the device supported the CMD8 command and didn&#39;t complain about our host</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;voltage range.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Most likely this means it is either a v2.0 spec standard or high capacity SD card (SDHC)</font>
 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Send CMD58 (Read OCR [operating conditions register]). &nbsp;Response type is R3, which has 5 bytes.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;uint8_t 4 = normal R1 response uint8_t, bytes 3-0 are = OCR register value.</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font> <font color="#434f54">=</font> <font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_READ_OCR</font><font color="#434f54">,</font> <font color="#000000">0x0</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Now that we have the OCR register value in the response packet, we could parse</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;the register contents and learn what voltage the SD card wants to run at.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;If our host circuitry has variable power supply capability, it could </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;theoretically adjust the SD card Vdd to the minimum of the OCR to save power.</font>
 &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Now send CMD55&#47;ACMD41 in a loop, until the card is finished with its internal initialization.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Note: SD card specs recommend &gt;= 1 second timeout while waiting for ACMD41 to signal non-busy.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">for</font><font color="#000000">(</font><font color="#000000">timeout</font> <font color="#434f54">=</font> <font color="#000000">0</font><font color="#000000">;</font> <font color="#000000">timeout</font> <font color="#434f54">&lt;</font> <font color="#000000">0xFFFF</font><font color="#000000">;</font> <font color="#000000">timeout</font><font color="#434f54">++</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Send CMD55 (lets SD card know that the next command is application specific (going to be ACMD41)).</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_APP_CMD</font><font color="#434f54">,</font> <font color="#000000">0x00000000</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Send ACMD41. &nbsp;This is to check if the SD card is finished booting up&#47;ready for full frequency and all</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;further commands. &nbsp;Response is R3 type (6 bytes&#47;48 bits, middle four bytes contain potentially useful data).</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Note: When sending ACMD41, the HCS bit is bit 30, and must be = 1 to tell SD card the host supports SDHC</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font> <font color="#434f54">=</font> <font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_SD_SEND_OP_COND</font><font color="#434f54">,</font><font color="#000000">0x40000000</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;bit 30 set</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;The R1 response should be = 0x00, meaning the card is now in the &#34;standby&#34; state, instead of</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;the &#34;idle&#34; state (which is the default initialization state after CMD0 reset is issued). &nbsp;Once</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;in the &#34;standby&#34; state, the SD card is finished with basic initialization and is ready </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;for read&#47;write and other commands.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r1</font><font color="#434f54">.</font><font color="#000000">_byte</font> <font color="#434f54">==</font> <font color="#000000">0</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">break</font><font color="#000000">;</font> &nbsp;<font color="#434f54">&#47;&#47;Break out of for() loop. &nbsp;Card is finished initializing.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">timeout</font> <font color="#434f54">&gt;=</font> <font color="#000000">0xFFFF</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">errorCode</font> <font color="#434f54">=</font> <font color="#000000">MEDIA_CANNOT_INITIALIZE</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Now send CMD58 (Read OCR register). &nbsp;The OCR register contains important</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;info we will want to know about the card (ex: standard capacity vs. SDHC).</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font> <font color="#434f54">=</font> <font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_READ_OCR</font><font color="#434f54">,</font> <font color="#000000">0x0</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Now check the CCS bit (OCR bit 30) in the OCR register, which is in our response packet.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;This will tell us if it is a SD high capacity (SDHC) or standard capacity device.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r7</font><font color="#434f54">.</font><font color="#000000">bytewise</font><font color="#434f54">.</font><font color="#000000">argument</font><font color="#434f54">.</font><font color="#000000">_returnVal</font> <font color="#434f54">&amp;</font> <font color="#000000">0x40000000</font><font color="#000000">)</font> &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Note the HCS bit is only valid when the busy bit is also set (indicating device ready).</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">gSDMode</font> <font color="#434f54">=</font> <font color="#000000">SD_MODE_HC</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">gSDMode</font> <font color="#434f54">=</font> <font color="#000000">SD_MODE_NORMAL</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;SD Card should now be finished with initialization sequence. &nbsp;Device should be ready</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;for read&#47;write commands.</font>

 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#434f54">&#47;&#47;if(((response.r7.bytewise._returnVal &amp; 0xFFF) == 0x1AA) &amp;&amp; (!response.r7.bitwise.bits.ILLEGAL_CMD))</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;The CMD8 wasn&#39;t supported. &nbsp;This means the card is not a v2.0 card.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Presumably the card is v1.x device, standard capacity (not SDHC).</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#95a5a6">&#47;* Need to delay a bit between last command and this command. *&#47;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SDSPI_DelayMilliseconds</font><font color="#000000">(</font><font color="#000000">SD_SPI_COMMAND_WAIT_MS</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipSelect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; select the device</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;The CMD8 wasn&#39;t supported. &nbsp;This means the card is definitely not a v2.0 SDHC card.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">gSDMode</font> <font color="#434f54">=</font> <font color="#000000">SD_MODE_NORMAL</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; According to the spec CMD1 must be repeated until the card is fully initialized</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">timeout</font> <font color="#434f54">=</font> <font color="#000000">0x1FFF</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">do</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Send CMD1 to initialize the media.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font> <font color="#434f54">=</font> <font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_SEND_OP_COND</font><font color="#434f54">,</font> <font color="#000000">0x00000000</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;When argument is 0x00000000, this queries MMC cards for operating voltage range</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">timeout</font><font color="#434f54">--</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#5e6d03">while</font><font color="#000000">(</font><font color="#000000">(</font><font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r1</font><font color="#434f54">.</font><font color="#000000">_byte</font> <font color="#434f54">!=</font> <font color="#000000">0x00</font><font color="#000000">)</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">(</font><font color="#000000">timeout</font> <font color="#434f54">!=</font> <font color="#000000">0</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; see if it failed</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">timeout</font> <font color="#434f54">==</font> <font color="#000000">0</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">errorCode</font> <font color="#434f54">=</font> <font color="#000000">MEDIA_CANNOT_INITIALIZE</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipDeselect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; deselect the devices</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Set read&#47;write block length to 512 bytes. &nbsp;Note: commented out since</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;this theoretically isn&#39;t necessary, since all cards v1 and v2 are </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;required to support 512 byte block size, and this is supposed to be</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;the default size selected on cards that support other sizes as well.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;response = SD_SendCmd(SET_BLOCKLEN, 0x00000200); &nbsp;&nbsp;&nbsp;&#47;&#47;Set read&#47;write block length to 512 bytes</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>

 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Temporarily deselect device</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipDeselect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_close</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">SD_SPI_master_open</font><font color="#000000">(</font><font color="#000000">SDFAST</font><font color="#000000">)</font> <font color="#434f54">==</font> <font color="#00979c">false</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#00979c">false</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipSelect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;<font color="#95a5a6">&#47;* Send the CMD9 to read the CSD register *&#47;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">timeout</font> <font color="#434f54">=</font> <font color="#000000">SD_NCR_TIMEOUT</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">do</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Send CMD9: Read CSD data structure.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font> <font color="#434f54">=</font> <font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_SEND_CSD</font><font color="#434f54">,</font> <font color="#000000">0x00</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">timeout</font><font color="#434f54">--</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#5e6d03">while</font><font color="#000000">(</font><font color="#000000">(</font><font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r1</font><font color="#434f54">.</font><font color="#000000">_byte</font> <font color="#434f54">!=</font> <font color="#000000">0x00</font><font color="#000000">)</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">(</font><font color="#000000">timeout</font> <font color="#434f54">!=</font> <font color="#000000">0</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">timeout</font> <font color="#434f54">==</font> <font color="#000000">0x00</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Media failed to respond to the read CSD register operation. &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">errorCode</font> <font color="#434f54">=</font> <font color="#000000">MEDIA_CANNOT_INITIALIZE</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipDeselect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_close</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#00979c">false</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;

 &nbsp;&nbsp;&nbsp;<font color="#95a5a6">&#47;* According to the simplified spec, section 7.2.6, the card will respond</font>
<font color="#95a5a6"> &nbsp;&nbsp;&nbsp;with a standard response token, followed by a data block of 16 bytes</font>
<font color="#95a5a6"> &nbsp;&nbsp;&nbsp;suffixed with a 16-bit CRC.*&#47;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">index</font> <font color="#434f54">=</font> <font color="#000000">0</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">for</font> <font color="#000000">(</font><font color="#000000">count</font> <font color="#434f54">=</font> <font color="#000000">0</font><font color="#000000">;</font> <font color="#000000">count</font> <font color="#434f54">&lt;</font> <font color="#000000">20u</font><font color="#000000">;</font> <font color="#000000">count</font> <font color="#434f54">++</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">CSDResponse</font><font color="#000000">[</font><font color="#000000">index</font><font color="#000000">]</font> <font color="#434f54">=</font> <font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">index</font><font color="#434f54">++</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#95a5a6">&#47;* Hopefully the first byte is the datatoken, however, some cards do</font>
<font color="#95a5a6"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;not send the response token before the CSD register.*&#47;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">(</font><font color="#000000">count</font> <font color="#434f54">==</font> <font color="#000000">0</font><font color="#000000">)</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">(</font><font color="#000000">CSDResponse</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font> <font color="#434f54">==</font> <font color="#000000">SD_TOKEN_START</font><font color="#000000">)</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#95a5a6">&#47;* As the first byte was the datatoken, we can drop it. *&#47;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">index</font> <font color="#434f54">=</font> <font color="#000000">0</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>

 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Extract some fields from the response for computing the card capacity.</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Note: The structure format depends on if it is a CSD V1 or V2 device.</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Therefore, need to first determine version of the specs that the card </font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;is designed for, before interpreting the individual fields.</font>

 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;-------------------------------------------------------------</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;READ_BL_LEN: CSD Structure v1 cards always support 512 uint8_t</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;read and write block lengths. &nbsp;Some v1 cards may optionally report</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;READ_BL_LEN = 1024 or 2048 bytes (and therefore WRITE_BL_LEN also</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;1024 or 2048). &nbsp;However, even on these cards, 512 uint8_t partial reads</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;and 512 uint8_t write are required to be supported.</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;On CSD structure v2 cards, it is always required that READ_BL_LEN </font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;(and therefore WRITE_BL_LEN) be 512 bytes, and partial reads and</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;writes are not allowed.</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Therefore, all cards support 512 byte reads&#47;writes, but only a subset</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;of cards support other sizes. &nbsp;For best compatibility with all cards,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;and the simplest firmware design, it is therefore preferable to </font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;simply ignore the READ_BL_LEN and WRITE_BL_LEN values altogether,</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;and simply hardcode the read&#47;write block size as 512 bytes.</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;-------------------------------------------------------------</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">sectorSize</font> <font color="#434f54">=</font> <font color="#000000">SD_MEDIA_BLOCK_SIZE</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Calculate the finalLBA (see SD card physical layer simplified spec 2.0, section 5.3.2).</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;In USB mass storage applications, we will need this information to </font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;correctly respond to SCSI get capacity requests. &nbsp;Note: method of computing </font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;finalLBA depends on CSD structure spec version (either v1 or v2).</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">CSDResponse</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font> <font color="#434f54">&amp;</font> <font color="#000000">0xC0</font><font color="#000000">)</font> <font color="#434f54">&#47;&#47;Check CSD_STRUCTURE field for v2+ struct device</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Must be a v2 device (or a reserved higher version, that doesn&#39;t currently exist)</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Extract the C_SIZE field from the response. &nbsp;It is a 22-bit number in bit position 69:48. &nbsp;This is different from v1. &nbsp;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;It spans bytes 7, 8, and 9 of the response.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">c_size</font> <font color="#434f54">=</font> <font color="#000000">(</font><font color="#000000">(</font><font color="#000000">(</font><font color="#00979c">uint32_t</font><font color="#000000">)</font><font color="#000000">CSDResponse</font><font color="#000000">[</font><font color="#000000">7</font><font color="#000000">]</font> <font color="#434f54">&amp;</font> <font color="#000000">0x3F</font><font color="#000000">)</font> <font color="#434f54">&lt;&lt;</font> <font color="#000000">16</font><font color="#000000">)</font> <font color="#434f54">|</font> <font color="#000000">(</font><font color="#000000">(</font><font color="#00979c">uint16_t</font><font color="#000000">)</font><font color="#000000">CSDResponse</font><font color="#000000">[</font><font color="#000000">8</font><font color="#000000">]</font> <font color="#434f54">&lt;&lt;</font> <font color="#000000">8</font><font color="#000000">)</font> <font color="#434f54">|</font> <font color="#000000">CSDResponse</font><font color="#000000">[</font><font color="#000000">9</font><font color="#000000">]</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">finalLBA</font> <font color="#434f54">=</font> <font color="#000000">(</font><font color="#000000">(</font><font color="#00979c">uint32_t</font><font color="#000000">)</font><font color="#000000">(</font><font color="#000000">c_size</font> <font color="#434f54">+</font> <font color="#000000">1</font><font color="#000000">)</font> <font color="#434f54">*</font> <font color="#000000">(</font><font color="#00979c">uint16_t</font><font color="#000000">)</font><font color="#000000">(</font><font color="#000000">1024u</font><font color="#000000">)</font><font color="#000000">)</font> <font color="#434f54">-</font> <font color="#000000">1</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;-1 on end is correction factor, since LBA = 0 is valid.</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font> <font color="#434f54">&#47;&#47;if(CSDResponse[0] &amp; 0xC0) &nbsp;&#47;&#47;Check CSD_STRUCTURE field for v1 struct device</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Must be a v1 device.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Extract the C_SIZE field from the response. &nbsp;It is a 12-bit number in bit position 73:62. &nbsp;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Although it is only a 12-bit number, it spans bytes 6, 7, and 8, since it isn&#39;t byte aligned.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">c_size</font> <font color="#434f54">=</font> <font color="#000000">(</font><font color="#000000">(</font><font color="#00979c">uint32_t</font><font color="#000000">)</font><font color="#000000">CSDResponse</font><font color="#000000">[</font><font color="#000000">6</font><font color="#000000">]</font> <font color="#434f54">&lt;&lt;</font> <font color="#000000">16</font><font color="#000000">)</font> <font color="#434f54">|</font> <font color="#000000">(</font><font color="#000000">(</font><font color="#00979c">uint16_t</font><font color="#000000">)</font><font color="#000000">CSDResponse</font><font color="#000000">[</font><font color="#000000">7</font><font color="#000000">]</font> <font color="#434f54">&lt;&lt;</font> <font color="#000000">8</font><font color="#000000">)</font> <font color="#434f54">|</font> <font color="#000000">CSDResponse</font><font color="#000000">[</font><font color="#000000">8</font><font color="#000000">]</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;Get the bytes in the correct positions</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">c_size</font> <font color="#434f54">&amp;=</font> <font color="#000000">0x0003FFC0</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;Clear all bits that aren&#39;t part of the C_SIZE</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">c_size</font> <font color="#434f54">=</font> <font color="#000000">c_size</font> <font color="#434f54">&gt;&gt;</font> <font color="#000000">6</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;Shift value down, so the 12-bit C_SIZE is properly right justified in the uint32_t.</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Extract the C_SIZE_MULT field from the response. &nbsp;It is a 3-bit number in bit position 49:47.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">c_size_mult</font> <font color="#434f54">=</font> <font color="#000000">(</font><font color="#000000">(</font><font color="#00979c">uint16_t</font><font color="#000000">)</font><font color="#000000">(</font><font color="#000000">(</font><font color="#000000">CSDResponse</font><font color="#000000">[</font><font color="#000000">9</font><font color="#000000">]</font> <font color="#434f54">&amp;</font> <font color="#000000">0x03</font><font color="#000000">)</font> <font color="#434f54">&lt;&lt;</font> <font color="#000000">1</font><font color="#000000">)</font><font color="#000000">)</font> <font color="#434f54">|</font> <font color="#000000">(</font><font color="#000000">(</font><font color="#00979c">uint16_t</font><font color="#000000">)</font><font color="#000000">(</font><font color="#000000">(</font><font color="#000000">CSDResponse</font><font color="#000000">[</font><font color="#000000">10</font><font color="#000000">]</font> <font color="#434f54">&amp;</font> <font color="#000000">0x80</font><font color="#000000">)</font> <font color="#434f54">&gt;&gt;</font> <font color="#000000">7</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Extract the BLOCK_LEN field from the response. It is a 4-bit number in bit position 83:80.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">block_len</font> <font color="#434f54">=</font> <font color="#000000">CSDResponse</font><font color="#000000">[</font><font color="#000000">5</font><font color="#000000">]</font> <font color="#434f54">&amp;</font> <font color="#000000">0x0F</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">block_len</font> <font color="#434f54">=</font> <font color="#000000">1</font> <font color="#434f54">&lt;&lt;</font> <font color="#000000">(</font><font color="#000000">block_len</font> <font color="#434f54">-</font> <font color="#000000">9</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;-9 because we report the size in sectors of 512 bytes each</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Calculate the finalLBA (see SD card physical layer simplified spec 2.0, section 5.3.2).</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;In USB mass storage applications, we will need this information to </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;correctly respond to SCSI get capacity requests (which will cause SD_CapacityRead() to get called).</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">finalLBA</font> <font color="#434f54">=</font> <font color="#000000">(</font><font color="#000000">(</font><font color="#00979c">uint32_t</font><font color="#000000">)</font><font color="#000000">(</font><font color="#000000">c_size</font> <font color="#434f54">+</font> <font color="#000000">1</font><font color="#000000">)</font> <font color="#434f54">*</font> <font color="#000000">(</font><font color="#00979c">uint16_t</font><font color="#000000">)</font><font color="#000000">(</font><font color="#000000">(</font><font color="#00979c">uint16_t</font><font color="#000000">)</font><font color="#000000">1</font> <font color="#434f54">&lt;&lt;</font> <font color="#000000">(</font><font color="#000000">c_size_mult</font> <font color="#434f54">+</font> <font color="#000000">2</font><font color="#000000">)</font><font color="#000000">)</font> <font color="#434f54">*</font> <font color="#000000">block_len</font><font color="#000000">)</font> <font color="#434f54">-</font> <font color="#000000">1</font><font color="#000000">;</font> &nbsp;<font color="#434f54">&#47;&#47;-1 on end is correction factor, since LBA = 0 is valid. &nbsp;&nbsp;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font> 

 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Turn off CRC7 if we can, might be an invalid cmd on some cards (CMD59)</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Note: POR default for the media is normally with CRC checking off in SPI </font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;mode anyway, so this is typically redundant.</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_CRC_ON_OFF</font><font color="#434f54">,</font> <font color="#000000">0x0</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Now set the block length to media sector size. It should be already set to this.</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_SET_BLOCK_LENGTH</font> <font color="#434f54">,</font> <font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">sectorSize</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Deselect media while not actively accessing the card.</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipDeselect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Finished with the SD card initialization sequence.</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">errorCode</font> <font color="#434f54">==</font> <font color="#000000">MEDIA_NO_ERROR</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#d35400">state</font> <font color="#434f54">=</font> <font color="#000000">SD_STATE_READY_FOR_COMMAND</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_close</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#00979c">true</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_close</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#00979c">false</font><font color="#000000">;</font>

<font color="#000000">}</font>

<font color="#00979c">bool</font> <font color="#000000">SDSPI_IsMediaInitialized</font><font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">(</font><font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#d35400">state</font> <font color="#434f54">!=</font> <font color="#000000">SD_STATE_NOT_INITIALIZED</font><font color="#000000">)</font><font color="#000000">;</font>
<font color="#000000">}</font>

<font color="#00979c">bool</font> <font color="#000000">SDSPI_IsWriteProtected</font><font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_SPI_GetWriteProtect</font><font color="#000000">(</font><font color="#000000">)</font> <font color="#434f54">?</font> <font color="#00979c">true</font> <font color="#434f54">:</font> <font color="#00979c">false</font><font color="#000000">;</font>
<font color="#000000">}</font>

<font color="#00979c">uint16_t</font> <font color="#000000">SDSPI_GetSectorSize</font><font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">sectorSize</font><font color="#000000">;</font>
<font color="#000000">}</font>

<font color="#00979c">uint32_t</font> <font color="#000000">SDSPI_GetSectorCount</font><font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">(</font><font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">finalLBA</font><font color="#000000">)</font><font color="#000000">;</font>
<font color="#000000">}</font>

<font color="#00979c">bool</font> <font color="#000000">SDSPI_SectorRead</font><font color="#000000">(</font><font color="#00979c">uint32_t</font> <font color="#000000">sector_address</font><font color="#434f54">,</font> <font color="#00979c">uint8_t</font><font color="#434f54">*</font> <font color="#d35400">buffer</font><font color="#434f54">,</font> <font color="#00979c">uint16_t</font> <font color="#000000">sector_count</font><font color="#000000">)</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">struct</font> <font color="#000000">SD_ASYNC_IO</font> <font color="#000000">info</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> <font color="#d35400">status</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">bool</font> <font color="#000000">result</font> <font color="#434f54">=</font> <font color="#00979c">false</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint16_t</font> <font color="#000000">i</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">for</font><font color="#000000">(</font><font color="#000000">i</font><font color="#434f54">=</font><font color="#000000">0</font><font color="#000000">;</font> <font color="#000000">i</font><font color="#434f54">&lt;</font><font color="#000000">sector_count</font><font color="#000000">;</font> <font color="#000000">i</font><font color="#434f54">++</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Initialize info structure for using the SD_SPI_AsyncReadTasks() function.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">.</font><font color="#000000">wNumBytes</font> <font color="#434f54">=</font> <font color="#000000">1</font> <font color="#434f54">&lt;&lt;</font> <font color="#000000">9</font><font color="#000000">;</font> &nbsp;<font color="#434f54">&#47;&#47;Equivalent to multiply by 512</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">.</font><font color="#000000">dwBytesRemaining</font> <font color="#434f54">=</font> <font color="#000000">1</font> <font color="#434f54">&lt;&lt;</font> <font color="#000000">9</font><font color="#000000">;</font> &nbsp;<font color="#434f54">&#47;&#47;Equivalent to multiply by 512</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">.</font><font color="#000000">pBuffer</font> <font color="#434f54">=</font> <font color="#d35400">buffer</font> <font color="#434f54">+</font> <font color="#000000">(</font><font color="#000000">i</font> <font color="#434f54">&lt;&lt;</font> <font color="#000000">9</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;Equivalent to multiply by 512</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">.</font><font color="#000000">dwAddress</font> <font color="#434f54">=</font> <font color="#000000">sector_address</font> <font color="#434f54">+</font> <font color="#000000">i</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">.</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_READ_QUEUED</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font> <font color="#000000">SD_SPI_master_open</font><font color="#000000">(</font><font color="#000000">SDFAST</font><font color="#000000">)</font> <font color="#434f54">==</font> <font color="#00979c">false</font> <font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#00979c">false</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipSelect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font><font color="#000000">(</font><font color="#000000">1</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">status</font> <font color="#434f54">=</font> <font color="#000000">SD_SPI_AsyncReadTasks</font><font color="#000000">(</font><font color="#434f54">&amp;</font><font color="#000000">info</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#d35400">status</font> <font color="#434f54">==</font> <font color="#000000">SD_ASYNC_READ_COMPLETE</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">result</font> <font color="#434f54">=</font> <font color="#00979c">true</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">break</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font> <font color="#5e6d03">if</font><font color="#000000">(</font><font color="#d35400">status</font> <font color="#434f54">==</font> <font color="#000000">SD_ASYNC_READ_ERROR</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">result</font> <font color="#434f54">=</font> <font color="#00979c">false</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">break</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipDeselect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_close</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">result</font><font color="#000000">;</font>
<font color="#000000">}</font>

<font color="#00979c">bool</font> <font color="#000000">SDSPI_SectorWrite</font><font color="#000000">(</font><font color="#00979c">uint32_t</font> <font color="#000000">sector_address</font><font color="#434f54">,</font> <font color="#00979c">const</font> <font color="#00979c">uint8_t</font><font color="#434f54">*</font> <font color="#d35400">buffer</font><font color="#434f54">,</font> <font color="#00979c">uint16_t</font> <font color="#000000">sector_count</font><font color="#000000">)</font>
<font color="#000000">{</font>
<font color="#00979c">struct</font> <font color="#000000">SD_ASYNC_IO</font> <font color="#000000">info</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> <font color="#d35400">status</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">bool</font> <font color="#000000">result</font> <font color="#434f54">=</font> <font color="#00979c">false</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint16_t</font> <font color="#000000">i</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">for</font><font color="#000000">(</font><font color="#000000">i</font><font color="#434f54">=</font><font color="#000000">0</font><font color="#000000">;</font> <font color="#000000">i</font><font color="#434f54">&lt;</font><font color="#000000">sector_count</font><font color="#000000">;</font> <font color="#000000">i</font><font color="#434f54">++</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Initialize structure so we write a single sector worth of data.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">.</font><font color="#000000">wNumBytes</font> <font color="#434f54">=</font> <font color="#000000">1</font> <font color="#434f54">&lt;&lt;</font> <font color="#000000">9</font><font color="#000000">;</font> &nbsp;<font color="#434f54">&#47;&#47;Equivalent to multiply by 512;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">.</font><font color="#000000">dwBytesRemaining</font> <font color="#434f54">=</font> <font color="#000000">1</font> <font color="#434f54">&lt;&lt;</font> <font color="#000000">9</font><font color="#000000">;</font> &nbsp;<font color="#434f54">&#47;&#47;Equivalent to multiply by 512</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">.</font><font color="#000000">pBuffer</font> <font color="#434f54">=</font> <font color="#000000">(</font><font color="#00979c">uint8_t</font><font color="#434f54">*</font><font color="#000000">)</font><font color="#d35400">buffer</font> <font color="#434f54">+</font> <font color="#000000">(</font><font color="#000000">i</font> <font color="#434f54">&lt;&lt;</font> <font color="#000000">9</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;Equivalent to multiply by 512</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">.</font><font color="#000000">dwAddress</font> <font color="#434f54">=</font> <font color="#000000">sector_address</font> <font color="#434f54">+</font> <font color="#000000">i</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">.</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_WRITE_QUEUED</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font> <font color="#000000">SD_SPI_master_open</font><font color="#000000">(</font><font color="#000000">SDFAST</font><font color="#000000">)</font> <font color="#434f54">==</font> <font color="#00979c">false</font> <font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#00979c">false</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipSelect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">while</font><font color="#000000">(</font><font color="#000000">1</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">status</font> <font color="#434f54">=</font> <font color="#000000">SD_SPI_AsyncWriteTasks</font><font color="#000000">(</font><font color="#434f54">&amp;</font><font color="#000000">info</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#d35400">status</font> <font color="#434f54">==</font> <font color="#000000">SD_ASYNC_WRITE_COMPLETE</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">result</font> <font color="#434f54">=</font> <font color="#00979c">true</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">break</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font> <font color="#5e6d03">if</font><font color="#000000">(</font><font color="#d35400">status</font> <font color="#434f54">==</font> <font color="#000000">SD_ASYNC_WRITE_ERROR</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">result</font> <font color="#434f54">=</font> <font color="#00979c">false</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">break</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipDeselect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_close</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">result</font><font color="#000000">;</font>
<font color="#000000">}</font>


<font color="#00979c">static</font> <font color="#00979c">uint8_t</font> <font color="#000000">SD_SPI_AsyncReadTasks</font><font color="#000000">(</font><font color="#00979c">struct</font> <font color="#000000">SD_ASYNC_IO</font><font color="#434f54">*</font> <font color="#000000">info</font><font color="#000000">)</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> <font color="#000000">bData</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_RESPONSE</font> <font color="#d35400">response</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">static</font> <font color="#00979c">uint16_t</font> <font color="#000000">blockCounter</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">static</font> <font color="#00979c">uint32_t</font> <font color="#000000">longTimeoutCounter</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">static</font> <font color="#00979c">bool</font> <font color="#000000">SingleBlockRead</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Check what state we are in, to decide what to do.</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">switch</font><font color="#000000">(</font><font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">case</font> <font color="#000000">SD_ASYNC_READ_COMPLETE</font><font color="#434f54">:</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_READ_COMPLETE</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">case</font> <font color="#000000">SD_ASYNC_READ_QUEUED</font><font color="#434f54">:</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Start the read request.</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Initialize some variables we will use later.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#d35400">state</font> <font color="#434f54">=</font> <font color="#000000">SD_STATE_BUSY</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Set global media status to busy, so no other code tries to send commands to the SD card</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">blockCounter</font> <font color="#434f54">=</font> &nbsp;<font color="#000000">SD_MEDIA_BLOCK_SIZE</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;Counter will be used later for block boundary tracking</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">ioInfo</font> <font color="#434f54">=</font> <font color="#434f54">*</font><font color="#000000">info</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;Get local copy of structure, for quicker access with less code size</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;SDHC cards are addressed on a 512 byte block basis. &nbsp;This is 1:1 equivalent</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;to LBA addressing. &nbsp;For standard capacity media, the media is expecting</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;a complete byte address. &nbsp;Therefore, to convert from the LBA address to the</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;byte address, we need to multiply by 512.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">gSDMode</font> <font color="#434f54">==</font> <font color="#000000">SD_MODE_NORMAL</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">dwAddress</font> <font color="#434f54">&lt;&lt;=</font> <font color="#000000">9</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;Equivalent to multiply by 512</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">dwBytesRemaining</font> <font color="#434f54">&lt;=</font> &nbsp;<font color="#000000">SD_MEDIA_BLOCK_SIZE</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SingleBlockRead</font> <font color="#434f54">=</font> <font color="#00979c">true</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font> <font color="#434f54">=</font> <font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_READ_SINGLE_BLOCK</font><font color="#434f54">,</font> <font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">dwAddress</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SingleBlockRead</font> <font color="#434f54">=</font> <font color="#00979c">false</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font> <font color="#434f54">=</font> <font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_READ_MULTI_BLOCK</font><font color="#434f54">,</font> <font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">dwAddress</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Note: SendMMCmd() sends 8 SPI clock cycles after getting the</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;response. &nbsp;This meets the NAC min timing parameter, so we don&#39;t</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;need additional clocking here.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; Make sure the command was accepted successfully</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r1</font><font color="#434f54">.</font><font color="#000000">_byte</font> <font color="#434f54">!=</font> <font color="#000000">0x00</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Perhaps the card isn&#39;t initialized or present.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_READ_ABORT</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_READ_BUSY</font><font color="#000000">;</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;We successfully sent the READ_MULTI_BLOCK command to the media.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;We now need to keep polling the media until it sends us the data</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;start token byte.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">longTimeoutCounter</font> <font color="#434f54">=</font> <font color="#000000">SD_NAC_TIMEOUT</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;prepare timeout counter for next state</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_READ_WAIT_START_TOKEN</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_READ_BUSY</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">case</font> <font color="#000000">SD_ASYNC_READ_WAIT_START_TOKEN</font><font color="#434f54">:</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;In this case, we have already issued the READ_MULTI_BLOCK command</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;to the media, and we need to keep polling the media until it sends</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;us the data start token byte. &nbsp;This could typically take a</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;couple&#47;few milliseconds, up to a maximum of 100ms.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">longTimeoutCounter</font> <font color="#434f54">!=</font> <font color="#000000">0x00000000</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">longTimeoutCounter</font><font color="#434f54">--</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">bData</font> <font color="#434f54">=</font> <font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">bData</font> <font color="#434f54">!=</font> <font color="#000000">SD_TOKEN_FLOATING_BUS</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">bData</font> <font color="#434f54">==</font> <font color="#000000">SD_TOKEN_START</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font> &nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;We got the start token. &nbsp;Ready to receive the data</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;block now.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_READ_NEW_PACKET_READY</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_READ_NEW_PACKET_READY</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;We got an unexpected non-0xFF, non-start token byte back?</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Some kind of error must have occurred. </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_READ_ABORT</font><font color="#000000">;</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_READ_BUSY</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Media is still busy. &nbsp;Start token not received yet.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_READ_BUSY</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;The media didn&#39;t respond with the start data token in the timeout</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;interval allowed. &nbsp;Operation failed. &nbsp;Abort the operation.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_READ_ABORT</font><font color="#000000">;</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_READ_BUSY</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">break</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">case</font> <font color="#000000">SD_ASYNC_READ_NEW_PACKET_READY</font><font color="#434f54">:</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;We have sent the READ_MULTI_BLOCK command and have successfully</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;received the data start token byte. &nbsp;Therefore, we are ready</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;to receive raw data bytes from the media.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">dwBytesRemaining</font> <font color="#434f54">!=</font> <font color="#000000">0x00000000</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Re-update local copy of pointer and number of bytes to read in this</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;call. &nbsp;These parameters are allowed to change between packets.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">wNumBytes</font> <font color="#434f54">=</font> <font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">wNumBytes</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">pBuffer</font> <font color="#434f54">=</font> <font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">pBuffer</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Update counters for state tracking and loop exit condition tracking.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">dwBytesRemaining</font> <font color="#434f54">-=</font> <font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">wNumBytes</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">blockCounter</font> <font color="#434f54">-=</font> <font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">wNumBytes</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Now read a ioInfo.wNumbytes packet worth of SPI bytes, </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;and place the received bytes in the user specified pBuffer.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#d35400">memset</font><font color="#000000">(</font><font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">pBuffer</font><font color="#434f54">,</font> <font color="#000000">0xFF</font><font color="#434f54">,</font> <font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">wNumBytes</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_exchangeBlock</font><font color="#000000">(</font><font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">pBuffer</font><font color="#434f54">,</font> <font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">wNumBytes</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Check if we have received a multiple of the media block </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;size (ex: 512 bytes). &nbsp;If so, the next two bytes are going to </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;be CRC values, rather than data bytes. &nbsp;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">blockCounter</font> <font color="#434f54">==</font> <font color="#000000">0</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Read two bytes to receive the CRC-16 value on the data block.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Following sending of the CRC-16 value, the media may still</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;need more access time to internally fetch the next block.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Therefore, it will send back 0xFF idle value, until it is</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;ready. &nbsp;Then it will send a new data start token, followed</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;by the next block of useful data.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">dwBytesRemaining</font> <font color="#434f54">!=</font> <font color="#000000">0x00000000</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_READ_WAIT_START_TOKEN</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">blockCounter</font> <font color="#434f54">=</font> &nbsp;<font color="#000000">SD_MEDIA_BLOCK_SIZE</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_READ_BUSY</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_READ_NEW_PACKET_READY</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#434f54">&#47;&#47;if(ioInfo.dwbytesRemaining != 0x00000000)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;We completed the read operation successfully and have returned</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;all data bytes requested.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Send CMD12 to let the media know we are finished reading</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;blocks from it, if we sent a multi-block read request earlier.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">SingleBlockRead</font> <font color="#434f54">==</font> <font color="#00979c">false</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_STOP_TRANSMISSION</font><font color="#434f54">,</font> <font color="#000000">0x00000000</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipDeselect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; De-select media</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_READ_COMPLETE</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#d35400">state</font> <font color="#434f54">=</font> <font color="#000000">SD_STATE_READY_FOR_COMMAND</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Free the media for new commands, since we are now done with it</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_READ_COMPLETE</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">case</font> <font color="#000000">SD_ASYNC_READ_ABORT</font><font color="#434f54">:</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;If the application firmware wants to cancel a read request.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_READ_ERROR</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Send CMD12 to terminate the multi-block read request.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font> <font color="#434f54">=</font> <font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_STOP_TRANSMISSION</font><font color="#434f54">,</font> <font color="#000000">0x00000000</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Fall through to SD_ASYNC_READ_ERROR&#47;default case.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">case</font> <font color="#000000">SD_ASYNC_READ_ERROR</font><font color="#434f54">:</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">default</font><font color="#434f54">:</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Some error must have happened.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipDeselect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; De-select media</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#d35400">state</font> <font color="#434f54">=</font> <font color="#000000">SD_STATE_READY_FOR_COMMAND</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_READ_ERROR</font><font color="#000000">;</font> 
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#434f54">&#47;&#47;switch(info-&gt;stateVariable) &nbsp;&nbsp;&nbsp;</font>
<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;


<font color="#00979c">static</font> <font color="#00979c">uint8_t</font> <font color="#000000">SD_SPI_AsyncWriteTasks</font><font color="#000000">(</font><font color="#00979c">struct</font> <font color="#000000">SD_ASYNC_IO</font><font color="#434f54">*</font> <font color="#000000">info</font><font color="#000000">)</font>
<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">static</font> <font color="#00979c">uint8_t</font> <font color="#000000">data_byte</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">static</font> <font color="#00979c">uint16_t</font> <font color="#000000">blockCounter</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">static</font> <font color="#00979c">uint32_t</font> <font color="#000000">WriteTimeout</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">static</font> <font color="#00979c">uint8_t</font> <font color="#000000">command</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint32_t</font> <font color="#000000">preEraseBlockCount</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_RESPONSE</font> <font color="#d35400">response</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Check what state we are in, to decide what to do.</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">switch</font><font color="#000000">(</font><font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">case</font> <font color="#000000">SD_ASYNC_WRITE_COMPLETE</font><font color="#434f54">:</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_WRITE_COMPLETE</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">case</font> <font color="#000000">SD_ASYNC_WRITE_QUEUED</font><font color="#434f54">:</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Initiate the write sequence.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#d35400">state</font> <font color="#434f54">=</font> <font color="#000000">SD_STATE_BUSY</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Let other code in the app know that the media is busy (so it doesn&#39;t also try to send the SD card commands of it&#39;s own)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">blockCounter</font> <font color="#434f54">=</font> <font color="#000000">SD_MEDIA_BLOCK_SIZE</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Initialize counter. &nbsp;Will be used later for block boundary tracking.</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Copy input structure into a statically allocated global instance </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;of the structure, for faster local access of the parameters with </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;smaller code size.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">ioInfo</font> <font color="#434f54">=</font> <font color="#434f54">*</font><font color="#000000">info</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Check if we are writing only a single block worth of data, or </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;multiple blocks worth of data.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">dwBytesRemaining</font> <font color="#434f54">&lt;=</font> &nbsp;<font color="#000000">SD_MEDIA_BLOCK_SIZE</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">command</font> <font color="#434f54">=</font> <font color="#000000">SD_WRITE_SINGLE_BLOCK</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">command</font> <font color="#434f54">=</font> <font color="#000000">SD_WRITE_MULTI_BLOCK</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Compute the number of blocks that we are going to be writing in this multi-block write operation.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">preEraseBlockCount</font> <font color="#434f54">=</font> <font color="#000000">(</font><font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">dwBytesRemaining</font> <font color="#434f54">&gt;&gt;</font> <font color="#000000">9</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;Divide by 512 to get the number of blocks to write</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Always need to erase at least one block.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">preEraseBlockCount</font> <font color="#434f54">==</font> <font color="#000000">0</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">preEraseBlockCount</font><font color="#434f54">++</font><font color="#000000">;</font> &nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> 
 &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Should send CMD55&#47;ACMD23 to let the media know how many blocks it should </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;pre-erase. &nbsp;This isn&#39;t essential, but it allows for faster multi-block </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;writes, and probably also reduces flash wear on the media.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font> <font color="#434f54">=</font> <font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_APP_CMD</font><font color="#434f54">,</font> <font color="#000000">0x00000000</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Send CMD55</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r1</font><font color="#434f54">.</font><font color="#000000">_byte</font> <font color="#434f54">==</font> <font color="#000000">0x00</font><font color="#000000">)</font> &nbsp;&nbsp;<font color="#434f54">&#47;&#47;Check if successful.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_SET_WRITE_BLOCK_ERASE_COUNT</font> <font color="#434f54">,</font> <font color="#000000">preEraseBlockCount</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Send ACMD23</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;The info-&gt;dwAddress parameter is the block address.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;For standard capacity SD cards, the card expects a complete byte address.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;To convert the block address into a byte address, we multiply by the block size (512).</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;For SDHC (high capacity) cards, the card expects a block address already, so no</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;address conversion is needed</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#000000">gSDMode</font> <font color="#434f54">==</font> <font color="#000000">SD_MODE_NORMAL</font><font color="#000000">)</font> &nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">dwAddress</font> <font color="#434f54">&lt;&lt;=</font> <font color="#000000">9</font><font color="#000000">;</font> &nbsp;&nbsp;<font color="#434f54">&#47;&#47;&lt;&lt; 9 multiplies by 512</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Send the write single or write multi command, with the LBA or byte </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;address (depending upon SDHC or standard capacity card)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font> <font color="#434f54">=</font> <font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">command</font><font color="#434f54">,</font> <font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">dwAddress</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;See if it was accepted</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r1</font><font color="#434f54">.</font><font color="#000000">_byte</font> <font color="#434f54">!=</font> <font color="#000000">0x00</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Perhaps the card isn&#39;t initialized or present.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_WRITE_ERROR</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_WRITE_ERROR</font><font color="#000000">;</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Card is ready to receive start token and data bytes.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_WRITE_TRANSMIT_PACKET</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_WRITE_SEND_PACKET</font><font color="#000000">;</font> &nbsp;&nbsp;

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">case</font> <font color="#000000">SD_ASYNC_WRITE_TRANSMIT_PACKET</font><font color="#434f54">:</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Check if we just finished programming a block, or we are starting</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;for the first time. &nbsp;In this case, we need to send the data start token.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">blockCounter</font> <font color="#434f54">==</font> &nbsp;<font color="#000000">SD_MEDIA_BLOCK_SIZE</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Send the correct data start token, based on the type of write we are doing</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">command</font> <font color="#434f54">==</font> <font color="#000000">SD_WRITE_MULTI_BLOCK</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font> <font color="#000000">(</font><font color="#000000">SD_TOKEN_START_MULTI_BLOCK</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Else must be a single block write</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font> <font color="#000000">(</font><font color="#000000">SD_TOKEN_START</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Update local copy of pointer and uint8_t count. &nbsp;Application firmware</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;is allowed to change these between calls to this handler function.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">wNumBytes</font> <font color="#434f54">=</font> <font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">wNumBytes</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">pBuffer</font> <font color="#434f54">=</font> <font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">pBuffer</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Keep track of variables for loop&#47;state exit conditions.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">dwBytesRemaining</font> <font color="#434f54">-=</font> <font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">wNumBytes</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">blockCounter</font> <font color="#434f54">-=</font> <font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">wNumBytes</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_exchangeBlock</font><font color="#000000">(</font><font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">pBuffer</font><font color="#434f54">,</font> <font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">wNumBytes</font><font color="#000000">)</font><font color="#000000">;</font>
 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Check if we have finished sending a 512 byte block. &nbsp;If so,</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;need to receive 16-bit CRC, and retrieve the data_response token</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">blockCounter</font> <font color="#434f54">==</font> <font color="#000000">0</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">blockCounter</font> <font color="#434f54">=</font> &nbsp;<font color="#000000">SD_MEDIA_BLOCK_SIZE</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Re-initialize counter</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;This version does not calculate CRC, send dummy data.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Read response token byte from media, mask out top three don&#39;t </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;care bits, and check if there was an error</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">(</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font> <font color="#434f54">&amp;</font> &nbsp;<font color="#000000">SD_WRITE_RESPONSE_TOKEN_MASK</font><font color="#000000">)</font> <font color="#434f54">!=</font> <font color="#000000">SD_TOKEN_DATA_ACCEPTED</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Something went wrong. &nbsp;Try and terminate as gracefully as </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;possible, so as allow possible recovery.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_WRITE_ABORT</font><font color="#000000">;</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_WRITE_BUSY</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;The media will now send busy token (0x00) bytes until</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;it is internally ready again (after the block is successfully</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;written and the card is ready to accept a new block.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_WRITE_MEDIA_BUSY</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">WriteTimeout</font> <font color="#434f54">=</font> <font color="#000000">SD_WRITE_TIMEOUT</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Initialize timeout counter</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_WRITE_BUSY</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#434f54">&#47;&#47;if(blockCounter == 0)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;If we get to here, we haven&#39;t reached a block boundary yet. &nbsp;Keep </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;on requesting packets of data from the application.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_WRITE_SEND_PACKET</font><font color="#000000">;</font> &nbsp;&nbsp;

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">case</font> <font color="#000000">SD_ASYNC_WRITE_MEDIA_BUSY</font><font color="#434f54">:</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">WriteTimeout</font> <font color="#434f54">!=</font> <font color="#000000">0</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">WriteTimeout</font><font color="#434f54">--</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;<font color="#434f54">&#47;&#47;Dummy read to gobble up a uint8_t (ex: to ensure we meet NBR timing parameter)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">data_byte</font> <font color="#434f54">=</font> <font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;<font color="#434f54">&#47;&#47;Poll the media. &nbsp;Will return 0x00 if still busy. &nbsp;Will return non-0x00 is ready for next data block.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">data_byte</font> <font color="#434f54">!=</font> <font color="#000000">0x00</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;The media is done and is no longer busy. &nbsp;Go ahead and</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;either send the next packet of data to the media, or the stop</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;token if we are finished.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">ioInfo</font><font color="#434f54">.</font><font color="#000000">dwBytesRemaining</font> <font color="#434f54">==</font> <font color="#000000">0</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">WriteTimeout</font> <font color="#434f54">=</font> <font color="#000000">SD_WRITE_TIMEOUT</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">command</font> <font color="#434f54">==</font> <font color="#000000">SD_WRITE_MULTI_BLOCK</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;We finished sending all bytes of data. &nbsp;Send the stop token uint8_t.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font> <font color="#000000">(</font><font color="#000000">SD_TOKEN_STOP_TRANSMISSION</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;After sending the stop transmission token, we need to</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;gobble up one uint8_t before checking for media busy (0x00).</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;This is to meet the NBR timing parameter. &nbsp;During the NBR</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;interval the SD card may not respond with the busy signal, even</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;though it is internally busy.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;The media still needs to finish internally writing.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_STOP_TOKEN_SENT_WAIT_BUSY</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_WRITE_BUSY</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;In this case we were doing a single block write,</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;so no stop token is necessary. &nbsp;In this case we are</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;now fully complete with the write operation.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipDeselect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; De-select media</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_WRITE_COMPLETE</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#d35400">state</font> <font color="#434f54">=</font> <font color="#000000">SD_STATE_READY_FOR_COMMAND</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Free the media for new commands, since we are now done with it</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_WRITE_COMPLETE</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Else we have more data to write in the multi-block write. &nbsp;&nbsp;&nbsp;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_WRITE_TRANSMIT_PACKET</font><font color="#000000">;</font> &nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_WRITE_SEND_PACKET</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;The media is still busy.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_WRITE_BUSY</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Timeout occurred. &nbsp;Something went wrong. &nbsp;The media should not </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;have taken this long to finish the write.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_WRITE_ABORT</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_WRITE_BUSY</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">case</font> <font color="#000000">SD_ASYNC_STOP_TOKEN_SENT_WAIT_BUSY</font><font color="#434f54">:</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;We already sent the stop transmit token for the multi-block write </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;operation. &nbsp;Now all we need to do, is keep waiting until the card</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;signals it is no longer busy. &nbsp;Card will keep sending 0x00 bytes</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;until it is no longer busy.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">WriteTimeout</font> <font color="#434f54">!=</font> <font color="#000000">0</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">WriteTimeout</font><font color="#434f54">--</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">data_byte</font> <font color="#434f54">=</font> <font color="#000000">SD_SPI_exchangeByte</font> <font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Check if card is no longer busy. &nbsp;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">data_byte</font> <font color="#434f54">!=</font> <font color="#000000">0x00</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;If we get to here, multi-block write operation is fully</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;complete now. &nbsp;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Should send CMD13 (SEND_STATUS) after a programming sequence, </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;to confirm if it was successful or not inside the media.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Prepare to receive the next command.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipDeselect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; De-select media</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;<font color="#434f54">&#47;&#47;NEC timing parameter clocking</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_WRITE_COMPLETE</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#d35400">state</font> <font color="#434f54">=</font> <font color="#000000">SD_STATE_READY_FOR_COMMAND</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Free the media for new commands, since we are now done with it</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_WRITE_COMPLETE</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;If we get to here, the media is still busy with the write.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_WRITE_BUSY</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font> &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Timeout occurred. &nbsp;Something went wrong. &nbsp;Fall through to SD_ASYNC_WRITE_ABORT.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">case</font> <font color="#000000">SD_ASYNC_WRITE_ABORT</font><font color="#434f54">:</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;An error occurred, and we need to stop the write sequence so as to try and allow</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;for recovery&#47;re-attempt later.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SendCmd</font><font color="#000000">(</font><font color="#000000">SD_STOP_TRANSMISSION</font><font color="#434f54">,</font> <font color="#000000">0x00000000</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipDeselect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;<font color="#434f54">&#47;&#47; De-select media</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;<font color="#434f54">&#47;&#47;After raising CS pin, media may not tri-state data out for 1 bit time.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">info</font><font color="#434f54">-</font><font color="#434f54">&gt;</font><font color="#000000">bStateVariable</font> <font color="#434f54">=</font> <font color="#000000">SD_ASYNC_WRITE_ERROR</font><font color="#000000">;</font> 
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Fall through to default case.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">default</font><font color="#434f54">:</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Used for SD_ASYNC_WRITE_ERROR case.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">mediaInformation</font><font color="#434f54">.</font><font color="#d35400">state</font> <font color="#434f54">=</font> <font color="#000000">SD_STATE_READY_FOR_COMMAND</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Free the media for new commands, since we are now done with it</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font> <font color="#000000">SD_ASYNC_WRITE_ERROR</font><font color="#000000">;</font> 
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#434f54">&#47;&#47;switch(info-&gt;stateVariable) &nbsp;&nbsp;&nbsp;</font>
<font color="#000000">}</font> 

<font color="#00979c">static</font> <font color="#000000">SD_RESPONSE</font> <font color="#000000">SD_SendCmd</font> <font color="#000000">(</font><font color="#00979c">uint8_t</font> <font color="#000000">cmd</font><font color="#434f54">,</font> <font color="#00979c">uint32_t</font> <font color="#000000">address</font><font color="#000000">)</font>
<font color="#000000">{</font> &nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_RESPONSE</font> &nbsp;&nbsp;&nbsp;<font color="#d35400">response</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint16_t</font> <font color="#000000">timeout</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint32_t</font> <font color="#000000">longTimeout</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#00979c">uint8_t</font> <font color="#000000">address_bytes</font><font color="#000000">[</font><font color="#000000">4</font><font color="#000000">]</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipSelect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#d35400">memcpy</font><font color="#000000">(</font><font color="#000000">address_bytes</font><font color="#434f54">,</font> <font color="#434f54">&amp;</font><font color="#000000">address</font><font color="#434f54">,</font> <font color="#00979c">sizeof</font><font color="#000000">(</font><font color="#000000">address</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">sdmmc_cmdtable</font><font color="#000000">[</font><font color="#000000">cmd</font><font color="#000000">]</font><font color="#434f54">.</font><font color="#000000">CmdCode</font> <font color="#434f54">|</font> <font color="#000000">SD_COMMAND_TRANSMIT_BIT_MASK</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">address_bytes</font><font color="#000000">[</font><font color="#000000">3</font><font color="#000000">]</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">address_bytes</font><font color="#000000">[</font><font color="#000000">2</font><font color="#000000">]</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">address_bytes</font><font color="#000000">[</font><font color="#000000">1</font><font color="#000000">]</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">address_bytes</font><font color="#000000">[</font><font color="#000000">0</font><font color="#000000">]</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;
 &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">sdmmc_cmdtable</font><font color="#000000">[</font><font color="#000000">cmd</font><font color="#000000">]</font><font color="#434f54">.</font><font color="#000000">CRC</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Special handling for CMD12 (STOP_TRANSMISSION). &nbsp;The very first byte after</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;sending the command packet may contain bogus non-0xFF data. &nbsp;This </font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;&#34;residual data&#34; byte should not be interpreted as the R1 response byte.</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">cmd</font> <font color="#434f54">==</font> <font color="#000000">SD_STOP_TRANSMISSION</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;Perform dummy read to fetch the residual non R1 byte</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font> 

 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Loop until we get a response from the media. &nbsp;Delay (NCR) could be up </font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;to 8 SPI byte times. &nbsp;First byte of response is always the equivalent of </font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;the R1 byte, even for R1b, R2, R3, R7 responses.</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">timeout</font> <font color="#434f54">=</font> <font color="#000000">SD_NCR_TIMEOUT</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">do</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r1</font><font color="#434f54">.</font><font color="#000000">_byte</font> <font color="#434f54">=</font> <font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">timeout</font><font color="#434f54">--</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#5e6d03">while</font><font color="#000000">(</font><font color="#000000">(</font><font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r1</font><font color="#434f54">.</font><font color="#000000">_byte</font> <font color="#434f54">==</font> <font color="#000000">SD_TOKEN_FLOATING_BUS</font><font color="#000000">)</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">(</font><font color="#000000">timeout</font> <font color="#434f54">!=</font> <font color="#000000">0</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Check if we should read more bytes, depending upon the response type expected. &nbsp;</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">sdmmc_cmdtable</font><font color="#000000">[</font><font color="#000000">cmd</font><font color="#000000">]</font><font color="#434f54">.</font><font color="#000000">responsetype</font> <font color="#434f54">==</font> <font color="#000000">SD_RESPONSE_R2</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r2</font><font color="#434f54">.</font><font color="#000000">_byte1</font> <font color="#434f54">=</font> <font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r1</font><font color="#434f54">.</font><font color="#000000">_byte</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;We already received the first byte, just make sure it is in the correct location in the struct.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r2</font><font color="#434f54">.</font><font color="#000000">_byte0</font> <font color="#434f54">=</font> <font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font> <font color="#434f54">&#47;&#47;Fetch the second byte of the response.</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font> <font color="#5e6d03">if</font><font color="#000000">(</font><font color="#000000">sdmmc_cmdtable</font><font color="#000000">[</font><font color="#000000">cmd</font><font color="#000000">]</font><font color="#434f54">.</font><font color="#000000">responsetype</font> <font color="#434f54">==</font> <font color="#000000">SD_RESPONSE_R1b</font><font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Keep trying to read from the media, until it signals it is no longer</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;busy. &nbsp;It will continuously send 0x00 bytes until it is not busy.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;A non-zero value means it is ready for the next command.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;The R1b response is received after a CMD12 STOP_TRANSMISSION</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;command, where the media card may be busy writing its internal buffer</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;to the flash memory. &nbsp;This can typically take a few milliseconds, </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;with a recommended maximum timeout of 250ms or longer for SD cards.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">longTimeout</font> <font color="#434f54">=</font> <font color="#000000">SD_WRITE_TIMEOUT</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#5e6d03">do</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r1</font><font color="#434f54">.</font><font color="#000000">_byte</font> <font color="#434f54">=</font> <font color="#000000">SD_SPI_exchangeByte</font> <font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">longTimeout</font><font color="#434f54">--</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">}</font><font color="#5e6d03">while</font><font color="#000000">(</font><font color="#000000">(</font><font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r1</font><font color="#434f54">.</font><font color="#000000">_byte</font> <font color="#434f54">==</font> <font color="#000000">0x00</font><font color="#000000">)</font> <font color="#434f54">&amp;&amp;</font> <font color="#000000">(</font><font color="#000000">longTimeout</font> <font color="#434f54">!=</font> <font color="#000000">0</font><font color="#000000">)</font><font color="#000000">)</font><font color="#000000">;</font>

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r1</font><font color="#434f54">.</font><font color="#000000">_byte</font> <font color="#434f54">=</font> <font color="#000000">0x00</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">else</font> <font color="#5e6d03">if</font> <font color="#000000">(</font><font color="#000000">sdmmc_cmdtable</font><font color="#000000">[</font><font color="#000000">cmd</font><font color="#000000">]</font><font color="#434f54">.</font><font color="#000000">responsetype</font> <font color="#434f54">==</font> <font color="#000000">SD_RESPONSE_R7</font><font color="#000000">)</font> <font color="#434f54">&#47;&#47;also used for response R3 type</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Fetch the other four bytes of the R3 or R7 response.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Note: The SD card argument response field is 32-bit, big endian format.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;However, the C compiler stores 32-bit values in little endian in RAM.</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;When writing to the _returnVal&#47;argument bytes, make sure the order it </font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;gets stored in is correct. &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r7</font><font color="#434f54">.</font><font color="#000000">bytewise</font><font color="#434f54">.</font><font color="#000000">argument</font><font color="#434f54">.</font><font color="#000000">_byte3</font> <font color="#434f54">=</font> <font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r7</font><font color="#434f54">.</font><font color="#000000">bytewise</font><font color="#434f54">.</font><font color="#000000">argument</font><font color="#434f54">.</font><font color="#000000">_byte2</font> <font color="#434f54">=</font> <font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r7</font><font color="#434f54">.</font><font color="#000000">bytewise</font><font color="#434f54">.</font><font color="#000000">argument</font><font color="#434f54">.</font><font color="#000000">_byte1</font> <font color="#434f54">=</font> <font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#d35400">response</font><font color="#434f54">.</font><font color="#000000">r7</font><font color="#434f54">.</font><font color="#000000">bytewise</font><font color="#434f54">.</font><font color="#000000">argument</font><font color="#434f54">.</font><font color="#000000">_byte0</font> <font color="#434f54">=</font> <font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>

 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;Device requires at least 8 clock pulses after</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;the response has been sent, before if can process</font>
 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47;the next command. &nbsp;CS may be high or low.</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">(</font><font color="#00979c">void</font><font color="#000000">)</font><font color="#000000">SD_SPI_exchangeByte</font><font color="#000000">(</font><font color="#000000">0xFF</font><font color="#000000">)</font><font color="#000000">;</font> &nbsp;&nbsp;&nbsp;

 &nbsp;&nbsp;&nbsp;<font color="#434f54">&#47;&#47; see if we are expecting more data or not</font>
 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">if</font><font color="#000000">(</font> <font color="#000000">sdmmc_cmdtable</font><font color="#000000">[</font><font color="#000000">cmd</font><font color="#000000">]</font><font color="#434f54">.</font><font color="#000000">moreDataExpected</font> <font color="#434f54">==</font> <font color="#00979c">false</font> <font color="#000000">)</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">{</font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#000000">SD_SPI_ChipDeselect</font><font color="#000000">(</font><font color="#000000">)</font><font color="#000000">;</font>
 &nbsp;&nbsp;&nbsp;<font color="#000000">}</font>

 &nbsp;&nbsp;&nbsp;<font color="#5e6d03">return</font><font color="#000000">(</font><font color="#d35400">response</font><font color="#000000">)</font><font color="#000000">;</font>
<font color="#000000">}</font>


</pre>